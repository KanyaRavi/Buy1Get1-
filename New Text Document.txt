Skip to content
This repository
Search
Pull requests
Issues
Gist
 @KanyaRavi
 Unwatch 14
  Star 0
 Fork 4 OneWhistle/whistle PRIVATE
 Code  Issues 20  Pull requests 0  Wiki  Pulse  Graphs
Branch: shortstay Find file Copy pathwhistle/controllers/notifications.js
f7baeaf  8 days ago
@PrasanthJayaraman PrasanthJayaraman changed quikrest to shortstay
3 contributors @sarathms @PrasanthJayaraman @vodolaz095
RawBlameHistory     462 lines (404 sloc)  13.1 KB
var
  restify = require('restify'),
  // SMS Notifications
  twilio = require('twilio'),
  twilioAccountSid, twilioAuthToken,
  mailer = require("nodemailer"),
  gcm = require('node-gcm'),
  dateformat = require('dateformat');

exports.init = function (io) {
  // SMS Notifications
  try {
    // Twilio Credentials
    twilioAccountSid = process.env.TWILIO_ACCOUNT_SID;
    twilioAuthToken = process.env.TWILIO_AUTH_TOKEN;

    if ((twilioAccountSid || twilioAuthToken) === false) {
      throw new Error("Twilio Credentials not found.");
    }

  } catch (e) {
    console.log(e.message);
  }
};

exports.sendVerificationCode = function (userPhone, ss,callback) {
  if (process.env.NODE_ENV !== 'production' &&
    process.env.GOD_MODE == "ON" &&
    JSON.parse(process.env.GOD_NUMBERS).indexOf(userPhone) !== -1) {
    return callback(null, userPhone.substr(-4, 4));
  }

  // Validate phone number format - +[1/2/3 digit country code][10 digit phone number]
  var phoneRegex = /^\+[0-9]{1,3}([0-9]{10})$/;
  if (!userPhone.match(phoneRegex)) {
    return callback(new Error("Phone number invalid."));
  }

  var phoneNumber = userPhone.slice(-10);
  var countryCode = userPhone.substr(0, userPhone.indexOf(phoneNumber));

  // Select SMS service provider based on country code
  switch (countryCode) {
    case '+91':
      // check if request is from shortstay or whistle
      debugger;
      if(ss != 'ss'){
        sendSMSmsg91(userPhone, callback);
      } else {
        sendShortstayWelcome(userPhone, callback);
      }
      break;

    // For US numbers, use Twilio
    case '+1':
      sendSMStwilio(userPhone, callback);
      break;

    default:
      return callback(new Error("Whistle is not supported in your country."));
  }
};

// For short stay

var sendShortstayWelcome = function (userPhone, callback) {
  var verification = generateShortstayMessage();
  var phone = userPhone.split('+')[1];
  var senderid = "SHSTAY";
  var smsAuthKey = process.env.MSG91_AUTHKEY || "badAuthKey";
  var smsGatewayURL = "http://api.msg91.com";
  var sendSMSQuery = "/api/sendhttp.php?" +
    "authkey=" + smsAuthKey +
    "&mobiles=" + phone +
    "&message=" + encodeURIComponent(verification.message) +
    "&sender=" + senderid +
    "&route=4";

  var restClient = restify.createClient({
    url: smsGatewayURL
  });
  debugger;
  console.log(phone)
  restClient.get(sendSMSQuery, function (err, req) {
    if (err) {
      console.log("SMSGateway request error: ");
      console.log(err);
      callback(err);
    }
    req.on('result', function (err, res) {
      if (err) {
        console.log("SMSGateway response error: ");
        console.log(err);
        callback(err);
      }
      if (res.statusCode === 200) {
        debugger;
        console.log("Sent verification code: " + verification.code);
        callback(null, verification.code);
      } else {
        // Non-200 status code
        callback(res.statusCode);
      }
    });
  });
};

var sendShortstayMessage = function (userphone, message, callback) {
  console.log(userphone);
  var phone = userphone.split('+')[1];
  console.log(phone);
  debugger;
  var senderid = "SHSTAY";
  var smsAuthKey = process.env.MSG91_AUTHKEY || "badAuthKey";
  var smsGatewayURL = "http://api.msg91.com";
  var sendSMSQuery = "/api/sendhttp.php?" +
    "authkey=" + smsAuthKey +
    "&mobiles=" + phone +
    "&message=" + encodeURIComponent(message) +
    "&sender=" + senderid +
    "&route=4";

  console.log(sendSMSQuery);
  console.log(smsAuthKey);

  var restClient = restify.createClient({
    url: smsGatewayURL
  });

  restClient.get(sendSMSQuery, function (err, req) {
    if (err) {
      console.log("SMSGateway request error: ");
      console.log(err);
      callback(err);
    }
    req.on('result', function (err, res) {
      if (err) {
        console.log("SMSGateway response error: ");
        console.log(err);
        callback(err);
      }
      if (res.statusCode === 200) {
        debugger;
        console.log("Message Sent " + message);
        callback(null, message);
      } else {
        // Non-200 status code
        callback(res.statusCode);
      }
    });
  });
};

exports.sendShortstayMessage = sendShortstayMessage;

exports.sendPassword = function (userPhone, pass, callback) {
  if (process.env.NODE_ENV !== 'production' &&
    process.env.GOD_MODE == "ON" &&
    JSON.parse(process.env.GOD_NUMBERS).indexOf(userPhone) !== -1) {
    return callback(null, userPhone.substr(-4, 4));
  }

  // Validate phone number format - +[1/2/3 digit country code][10 digit phone number]
  var phoneRegex = /^\+[0-9]{1,3}([0-9]{10})$/;
  if (!userPhone.match(phoneRegex)) {
    return callback(new Error("Phone number invalid."));
  }

  var phoneNumber = userPhone.slice(-10);
  var countryCode = userPhone.substr(0, userPhone.indexOf(phoneNumber));

  // Select SMS service provider based on country code
  switch (countryCode) {
    case '+91':
      sendShortstayMsg91(userPhone, pass, callback);
      break;

    default:
      return callback(new Error("Short Stay is not supported in your country."));
  }
};

var sendShortstayMsg91 = function (userPhone, pass, callback) {
  debugger;
  var verification = "Welcome to Short Stay. Your password is "+pass+". Please try login with this password.";
  var phone = userPhone.split('+')[1];
  var senderid = "SHSTAY";
  var smsAuthKey = process.env.MSG91_AUTHKEY || "badAuthKey";
  var smsGatewayURL = "http://api.msg91.com";
  var sendSMSQuery = "/api/sendhttp.php?" +
    "authkey=" + smsAuthKey +
    "&mobiles=" + phone +
    "&message=" + encodeURIComponent(verification) +
    "&sender=" + senderid +
    "&route=4";

  var restClient = restify.createClient({
    url: smsGatewayURL
  });

  restClient.get(sendSMSQuery, function (err, req) {
    if (err) {
      console.log("SMSGateway request error: ");
      console.log(err);
      callback(err);
    }
    req.on('result', function (err, res) {
      if (err) {
        console.log("SMSGateway response error: ");
        console.log(err);
        callback(err);
      }
      if (res.statusCode === 200) {
        callback(null, verification);
      } else {
        // Non-200 status code
        callback(res.statusCode);
      }
    });
  });
};

var sendSMStwilio = function (userPhone, callback) {

  //require the Twilio module and create a REST client
  var client = twilio(twilioAccountSid, twilioAuthToken);

  var verification = generateVerificationMessage();

  client.messages.create({
    to: userPhone,
    from: "+14085202777",
    body: verification.message
  }, function (err, response) {
    if (err) {
      callback(err);
    } else {
      console.log("Sent verificatin code " + verification.code + ". msgID: " + response.sid);
      callback(err, verification.code);
    }
  });
};

var sendSMSmsg91 = function (userPhone, callback) {
  debugger;
  var verification = generateVerificationMessage();
  var phone = userPhone.split('+')[1];
  var senderid = "WHISTL";
  var smsAuthKey = process.env.MSG91_AUTHKEY || "badAuthKey";
  var smsGatewayURL = "http://api.msg91.com";
  var sendSMSQuery = "/api/sendhttp.php?" +
    "authkey=" + smsAuthKey +
    "&mobiles=" + phone +
    "&message=" + encodeURIComponent(verification.message) +
    "&sender=" + senderid +
    "&route=4";

  var restClient = restify.createClient({
    url: smsGatewayURL
  });

  restClient.get(sendSMSQuery, function (err, req) {
    if (err) {
      console.log("SMSGateway request error: ");
      console.log(err);
      callback(err);
    }
    req.on('result', function (err, res) {
      if (err) {
        console.log("SMSGateway response error: ");
        console.log(err);
        callback(err);
      }
      if (res.statusCode === 200) {
        console.log("Sent verification code: " + verification.code);
        callback(null, verification.code);
      } else {
        // Non-200 status code
        callback(res.statusCode);
      }
    });
  });
};

var generateVerificationMessage = function () {
  var verificationCodeLen = 6;
  var verificationCode = ("" + Math.random()).substring(2, 2 + verificationCodeLen);

  var verificationMessage = "Welcome to Whistle. Use the code " +
    verificationCode +
    " to complete signing up with us. Happy Whistling.";
  return {
    message: verificationMessage,
    code: verificationCode
  };
};

var generateShortstayMessage = function () {
  var verificationCodeLen = 6;
  var verificationCode = ("" + Math.random()).substring(2, 2 + verificationCodeLen);

  var verificationMessage = "Welcome to Short Stay. Use the code " +
    verificationCode +
    " to complete signing up with us.";
  return {
    message: verificationMessage,
    code: verificationCode
  };
};
// Use Smtp Protocol to send Email
var smtpTransport = mailer.createTransport("SMTP",{
  service: 'Gmail',
    auth: {
      user: 'noreply.shortstay@gmail.com',
      pass: 'Shortstay@123'
    }
});

function sendMail(to, body, name, value, callback){
  var html = '', subject = '';

  switch(body){
    case 0:
      subject = "Short Stay - Forgot Password",
      html = "Hello "+name+", <br> Your Password is "+value+". Please try login <a href='www.short-stay.in'>here</a> If you have any questions or trouble logging please contact support@dowhistle.com";
      break;
  }

  var mail = {
      from: "Short Stay <noreply.shortstay@gmail.com>",
      to: to,
      subject: subject,
      html: html
  }

  smtpTransport.sendMail(mail, function(error, response){
      if(error){
          console.log(error);
          callback(error, 1);
      } else{
          console.log("Mail sent: " + response.message);
          smtpTransport.close();
          callback('', 0);
      }
  });
}

exports.sendMail = sendMail;

// push notification for short stay
function sendPush(type, regId, bookingid, callback){
  var msg;
  switch (type) {
    case 0:
      msg = "Your Booking has been confirmed & Booking Id is "+bookingid+". Short Stay wishes a wonderful stay!";
      break;
    case 1:
      msg = "Based on your request , Your Booking has been cancelled. Your Cancellation id is "+bookingid+". Hope to reconnect again - Short Stay.";
      break;
  }

  console.log(msg)
  var message = new gcm.Message();

  //API Server Key
  var sender = new gcm.Sender('AIzaSyDpKLJAj1bhU8HWYvg4qmQeUYd2N5nOUuQ');
  var registrationIds = [];

  // Value the payload data to send...
  message.addData('message',msg);
  message.addData('title','Short Stay' );
  message.addData('msgcnt','1'); // Shows up in the notification in the status bar
  message.addData('soundname','beep.wav'); //Sound to play upon notification receipt - put in the www folder in app
  //message.collapseKey = 'demo';
  //message.delayWhileIdle = true; //Default is false
  message.timeToLive = 3000;// Duration in seconds to hold in GCM and retry before timing out. Default 4 weeks (2,419,200 seconds) if not specified.

  // At least one reg id required
  registrationIds.push(regId);

  /**
   * Parameters: message-literal, registrationIds-array, No. of retries, callback-function
   */
  sender.send(message, registrationIds, 4, function (result) {
    console.log(result);
      if(result == 401){
        callback();  //authentication error
      } else if(result == null) {
        callback();  //ok status
      }
  });
}

exports.sendPush = sendPush;


exports.sendPasswordKey = function (userPhone, pass, callback) {
  if (process.env.NODE_ENV !== 'production' &&
    process.env.GOD_MODE == "ON" &&
    JSON.parse(process.env.GOD_NUMBERS).indexOf(userPhone) !== -1) {
    return callback(null, userPhone.substr(-4, 4));
  }

  // Validate phone number format - +[1/2/3 digit country code][10 digit phone number]
  var phoneRegex = /^\+[0-9]{1,3}([0-9]{10})$/;
  if (!userPhone.match(phoneRegex)) {
    return callback(new Error("Phone number invalid."));
  }

  var phoneNumber = userPhone.slice(-10);
  var countryCode = userPhone.substr(0, userPhone.indexOf(phoneNumber));

  // Select SMS service provider based on country code
  switch (countryCode) {
    case '+91':
      sendPasswordKeyMSG(userPhone, pass, callback);
      break;

    default:
      return callback(new Error("Short Stay is not supported in your country."));
  }
};

var sendPasswordKeyMSG = function (userPhone, pass, callback) {
  var verification = "Thanks for Whistling. Your password reset key is "+pass+" . Please use this to reset your password";
  var phone = userPhone.split('+')[1];
  var senderid = "WHISTL";
  var smsAuthKey = process.env.MSG91_AUTHKEY || "badAuthKey";
  var smsGatewayURL = "http://api.msg91.com";
  var sendSMSQuery = "/api/sendhttp.php?" +
    "authkey=" + smsAuthKey +
    "&mobiles=" + phone +
    "&message=" + encodeURIComponent(verification) +
    "&sender=" + senderid +
    "&route=4";

  var restClient = restify.createClient({
    url: smsGatewayURL
  });

  restClient.get(sendSMSQuery, function (err, req) {
    if (err) {
      console.log("SMSGateway request error: ");
      console.log(err);
      callback(err);
    }
    req.on('result', function (err, res) {
      if (err) {
        console.log("SMSGateway response error: ");
        console.log(err);
        callback(err);
      }
      if (res.statusCode === 200) {
        callback(null, verification);
      } else {
        // Non-200 status code
        callback(res.statusCode);
      }
    });
  });
};
Status API Training Shop Blog About
© 2016 GitHub, Inc. Terms Privacy Security Contact Help